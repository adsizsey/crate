#!/usr/bin/env bash
set -euo pipefail

BASE="$HOME/nfs-storage-ny"
SRC="$BASE/py37_src"
INSTALL="$BASE/local"
VENV_DIR="$BASE/venvs"
PY_PREFIX="$INSTALL/python-3.7"

mkdir -p "$INSTALL" "$VENV_DIR"

echo "### Using existing source folders under $SRC"
echo

###############################################################################
# 1. CLEAN ANY OLD BAD BUILDS INSIDE local (SAFE)
###############################################################################
echo "==> Cleaning old accidental CMake junk inside $INSTALL ..."
cd "$INSTALL"

rm -f CMakeCache.txt cmake_install.cmake Makefile config.h 2>/dev/null || true
rm -rf CMakeFiles 2>/dev/null || true

echo "   Cleaned."
echo

###############################################################################
# 2. REBUILD libffi FROM EXISTING FOLDER
###############################################################################
echo "==> Building libffi ..."
cd "$SRC/libffi-3.4.4"
make distclean 2>/dev/null || true

./configure \
  --prefix="$INSTALL/libffi" \
  --libdir="$INSTALL/libffi/lib64"

make -j4
make install

echo "   libffi installed into $INSTALL/libffi"
echo

###############################################################################
# 3. REBUILD libxml2 FROM EXISTING FOLDER (CMake)
###############################################################################
echo "==> Building libxml2 ..."

LIBXML_SRC="$SRC/libxml2-2.9.12"
LIBXML_PREFIX="$INSTALL/libxml2"

# Clean old build dir
rm -rf "$LIBXML_SRC/build" || true
mkdir -p "$LIBXML_SRC/build"
cd "$LIBXML_SRC/build"

cmake \
  -DCMAKE_INSTALL_PREFIX="$LIBXML_PREFIX" \
  -DLIBXML2_WITH_PYTHON=OFF \
  -DLIBXML2_WITH_LZMA=OFF \
  "$LIBXML_SRC"

make -j4
make install

echo "   libxml2 installed into $LIBXML_PREFIX"
echo

###############################################################################
# 4. REBUILD libxslt FROM EXISTING FOLDER
###############################################################################
echo "==> Building libxslt ..."

LIBXSLT_SRC="$SRC/libxslt-1.1.34"
rm -rf "$LIBXSLT_SRC/build" 2>/dev/null || true

cd "$LIBXSLT_SRC"
make distclean 2>/dev/null || true

./configure \
  --prefix="$INSTALL/libxslt" \
  --with-libxml-prefix="$LIBXML_PREFIX"

make -j4
make install

echo "   libxslt installed into $INSTALL/libxslt"
echo

###############################################################################
# 5. EXPORT ALL ENVIRONMENT VARIABLES
###############################################################################
echo "==> Setting environment variables ..."

unset CPPFLAGS LDFLAGS PKG_CONFIG_PATH LD_LIBRARY_PATH || true

# libffi
export CPPFLAGS="-I$INSTALL/libffi/include"
export LDFLAGS="-L$INSTALL/libffi/lib64"
export PKG_CONFIG_PATH="$INSTALL/libffi/lib64/pkgconfig"

# libxml2 + libxslt
export CPPFLAGS="$CPPFLAGS -I$LIBXML_PREFIX/include/libxml2 -I$INSTALL/libxslt/include"
export LDFLAGS="$LDFLAGS -L$LIBXML_PREFIX/lib -L$INSTALL/libxslt/lib"

# shared libs
export LD_LIBRARY_PATH="$INSTALL/libffi/lib64:$LIBXML_PREFIX/lib:$INSTALL/libxslt/lib"

echo "   CPPFLAGS=$CPPFLAGS"
echo "   LDFLAGS=$LDFLAGS"
echo "   LD_LIBRARY_PATH=$LD_LIBRARY_PATH"
echo

###############################################################################
# 6. REBUILD PYTHON 3.7 FROM EXISTING FOLDER
###############################################################################
echo "==> Building Python 3.7 ..."

PY_SRC_DIR=$(echo "$SRC"/Python-3.7*)
cd "$PY_SRC_DIR"

make distclean 2>/dev/null || true

./configure \
  --prefix="$PY_PREFIX" \
  --with-ensurepip=install

make -j4
make install

"$PY_PREFIX/bin/python3.7" -V
"$PY_PREFIX/bin/python3.7" -c "import ctypes; print('ctypes OK:', ctypes.__file__)"
echo

###############################################################################
# 7. CREATE / ACTIVATE VENV & INSTALL LXML + REQUIREMENTS
###############################################################################
echo "==> Creating and using venv ..."

VENV_PATH="$VENV_DIR/py37env"
"$PY_PREFIX/bin/python3.7" -m venv "$VENV_PATH"

# Activate venv
source "$VENV_PATH/bin/activate"

# Reapply env vars inside venv
export CPPFLAGS="$CPPFLAGS"
export LDFLAGS="$LDFLAGS"
export LD_LIBRARY_PATH="$LD_LIBRARY_PATH"

pip install --upgrade pip
pip install lxml

echo "=== DONE ==="
echo "Python: $PY_PREFIX/bin/python3.7"
echo "Venv:   $VENV_PATH"
